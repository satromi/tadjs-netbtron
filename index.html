<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Net-BTRON 招待管理</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "MS Gothic", "Hiragino Kaku Gothic ProN", monospace;
            font-size: 12px;
            background: #dedede;
            color: #000;
        }
        #app {
            max-width: 560px;
            margin: 24px auto;
            padding: 12px;
            background: #dedede;
        }
        h1 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 12px;
            padding-bottom: 4px;
            border-bottom: 2px solid #808080;
        }
        .panel {
            display: none;
            background: #e0e0e0;
            border: 1px solid #808080;
            padding: 12px;
            margin-bottom: 12px;
        }
        .panel.active { display: block; }
        .panel-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .form-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .form-row label {
            min-width: 80px;
            font-size: 11px;
        }
        input[type="text"], input[type="email"], select {
            font-family: inherit;
            font-size: 11px;
            padding: 3px 6px;
            border: 1px solid #808080;
            background: #fff;
            flex: 1;
        }
        select { flex: none; width: auto; }
        button, .btn {
            font-family: inherit;
            font-size: 11px;
            padding: 4px 12px;
            border: 1px solid #808080;
            background: #c0c0c0;
            cursor: pointer;
        }
        button:hover, .btn:hover { background: #d0d0d0; }
        button:active, .btn:active { background: #a0a0a0; }
        button:disabled { opacity: 0.5; cursor: default; }
        .btn-primary { background: #b8d0e8; }
        .btn-danger { background: #e8b8b8; }
        .btn-small { padding: 2px 8px; font-size: 10px; }
        #status-bar {
            font-size: 11px;
            padding: 4px 8px;
            min-height: 20px;
            border: 1px solid #808080;
            background: #f0f0f0;
        }
        .user-info {
            font-size: 11px;
            margin-bottom: 8px;
            padding: 4px 8px;
            background: #d8e8d8;
            border: 1px solid #808080;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 8px;
        }
        th {
            background: #c0c0c0;
            border: 1px solid #808080;
            padding: 3px 6px;
            text-align: left;
            font-weight: bold;
        }
        td {
            border: 1px solid #808080;
            padding: 3px 6px;
            background: #fff;
        }
        tr.expired td { opacity: 0.5; }
        tr.accepted td { opacity: 0.7; }
        .token-cell {
            font-family: monospace;
            font-size: 10px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .invite-form {
            border-top: 1px solid #808080;
            padding-top: 8px;
            margin-top: 8px;
        }
        .action-bar {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .tenant-selector {
            margin-bottom: 8px;
        }
        .error { color: #c00; }
        .success { color: #060; }
    </style>
</head>
<body>
    <div id="app">
        <h1>Net-BTRON 招待管理</h1>

        <!-- 接続設定パネル -->
        <div id="config-panel" class="panel active">
            <div class="panel-title">接続設定</div>
            <div class="form-row">
                <label>Supabase URL:</label>
                <input type="text" id="supabase-url" placeholder="https://xxxxxx.supabase.co">
            </div>
            <div class="form-row">
                <label>Anon Key:</label>
                <input type="text" id="supabase-key" placeholder="eyJ...">
            </div>
            <div class="action-bar">
                <button id="btn-connect" class="btn-primary">接続</button>
            </div>
        </div>

        <!-- ログインパネル -->
        <div id="login-panel" class="panel">
            <div class="panel-title">ログイン</div>
            <div style="text-align:center; padding:16px 0">
                <button id="btn-google-login" class="btn-primary" style="padding:8px 24px; font-size:12px">
                    Googleでログイン
                </button>
            </div>
        </div>

        <!-- 停止中パネル -->
        <div id="disabled-panel" class="panel">
            <div class="user-info">
                <span id="disabled-user-email"></span>
                <button id="btn-disabled-logout" class="btn-small">ログアウト</button>
            </div>
            <div style="text-align:center; padding:24px 0; color:#808080">
                招待管理機能は現在停止中です。<br>
                テナントオーナーがSQLで起動する必要があります。
            </div>
        </div>

        <!-- メインパネル -->
        <div id="main-panel" class="panel">
            <div class="user-info">
                <span id="user-email"></span>
                <button id="btn-logout" class="btn-small">ログアウト</button>
            </div>

            <div class="tenant-selector">
                <div class="form-row">
                    <label>テナント:</label>
                    <select id="tenant-select"></select>
                    <button id="btn-refresh" class="btn-small">更新</button>
                </div>
            </div>

            <div id="invite-list-area">
                <table id="invite-table">
                    <thead>
                        <tr>
                            <th>メール</th>
                            <th>ロール</th>
                            <th>ステータス</th>
                            <th>期限</th>
                            <th>招待コード</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="invite-tbody"></tbody>
                </table>
            </div>

            <div class="invite-form">
                <div class="panel-title">新規招待作成</div>
                <div class="form-row">
                    <label>メール(任意):</label>
                    <input type="email" id="new-invite-email" placeholder="user@example.com">
                </div>
                <div class="form-row">
                    <label>ロール:</label>
                    <select id="new-invite-role">
                        <option value="member">メンバー</option>
                        <option value="readonly">読取専用</option>
                        <option value="admin">管理者</option>
                    </select>
                    <button id="btn-create-invite" class="btn-primary">招待作成</button>
                </div>
            </div>
        </div>

        <!-- ステータスバー -->
        <div id="status-bar"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
    (function() {
        'use strict';

        const CONFIG_KEY = 'netbtron-invite-config';
        let _supabase = null;
        let _currentUser = null;
        let _adminTenants = [];

        // --- ユーティリティ ---

        function $(id) { return document.getElementById(id); }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function setStatus(msg, type) {
            const bar = $('status-bar');
            bar.textContent = msg;
            bar.className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
        }

        function showPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            $(id).classList.add('active');
        }

        function saveConfig(url, key) {
            localStorage.setItem(CONFIG_KEY, JSON.stringify({ url, key }));
        }

        function loadConfig() {
            try {
                return JSON.parse(localStorage.getItem(CONFIG_KEY));
            } catch { return null; }
        }

        // --- Supabase 初期化 ---

        function initSupabase(url, key) {
            _supabase = window.supabase.createClient(url, key);
            return _supabase;
        }

        // --- 認証 ---

        async function handleGoogleLogin() {
            if (!_supabase) return;
            setStatus('Google認証画面に移動します...');

            const redirectTo = window.location.origin + window.location.pathname;
            const { data, error } = await _supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo }
            });

            if (error) {
                setStatus('OAuth開始エラー: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            if (!_supabase) return;
            await _supabase.auth.signOut();
            _currentUser = null;
            _adminTenants = [];
            showPanel('login-panel');
            setStatus('ログアウトしました');
        }

        // --- admin判定 ---

        async function checkAdminAccess(session) {
            _currentUser = session.user;
            $('user-email').textContent = _currentUser.email || _currentUser.id;

            const { data: memberships, error } = await _supabase
                .from('tenant_members')
                .select('tenant_id, role')
                .eq('user_id', _currentUser.id)
                .eq('role', 'admin');

            if (error || !memberships || memberships.length === 0) {
                showPanel('login-panel');
                setStatus('管理権限のあるテナントがありません。adminまたはオーナーである必要があります。', 'error');
                return;
            }

            const tenantIds = memberships.map(m => m.tenant_id);
            const { data: tenants } = await _supabase
                .from('tenants')
                .select('id, name, owner_id')
                .in('id', tenantIds);

            if (!tenants || tenants.length === 0) {
                showPanel('login-panel');
                setStatus('テナント情報の取得に失敗しました', 'error');
                return;
            }

            _adminTenants = tenants;

            // 招待UI起動状態チェック
            const { data: uiEnabled, error: uiErr } = await _supabase.rpc('is_invite_ui_enabled');
            if (uiErr || uiEnabled !== true) {
                $('disabled-user-email').textContent = _currentUser.email || _currentUser.id;
                showPanel('disabled-panel');
                setStatus('招待管理機能は停止中です', 'error');
                return;
            }

            populateTenantSelector(tenants);
            showPanel('main-panel');
            await loadInvites();
            setStatus('ログイン完了: ' + _currentUser.email, 'success');
        }

        // --- テナント選択 ---

        function populateTenantSelector(tenants) {
            const sel = $('tenant-select');
            sel.innerHTML = '';
            tenants.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
        }

        function getSelectedTenantId() {
            return $('tenant-select').value;
        }

        // --- 招待管理 ---

        async function loadInvites() {
            const tenantId = getSelectedTenantId();
            if (!tenantId) return;

            setStatus('招待一覧を取得中...');
            const { data, error } = await _supabase.rpc('list_invites', { p_tenant_id: tenantId });

            if (error) {
                setStatus('招待一覧取得失敗: ' + error.message, 'error');
                return;
            }

            renderInviteTable(data || []);
            setStatus('招待一覧を更新しました (' + (data ? data.length : 0) + '件)', 'success');
        }

        function renderInviteTable(invites) {
            const tbody = $('invite-tbody');
            tbody.innerHTML = '';

            if (invites.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="6" style="text-align:center;color:#808080">招待がありません</td>';
                tbody.appendChild(tr);
                return;
            }

            invites.forEach(inv => {
                const tr = document.createElement('tr');
                const isExpired = new Date(inv.expires_at) < new Date();
                if (inv.status !== 'pending' || isExpired) {
                    tr.className = inv.status === 'accepted' ? 'accepted' : 'expired';
                }

                const roleLabel = inv.role === 'admin' ? '管理者'
                    : inv.role === 'member' ? 'メンバー' : '読取専用';
                const statusLabel = inv.status === 'pending' ? (isExpired ? '期限切れ' : '待機中')
                    : inv.status === 'accepted' ? '承認済' : '期限切れ';
                const expiresAt = new Date(inv.expires_at).toLocaleDateString('ja-JP');
                const emailDisplay = inv.email ? escapeHtml(inv.email) : '(制限なし)';
                const tokenShort = inv.token ? inv.token.substring(0, 8) + '...' : '';
                const isPending = inv.status === 'pending' && !isExpired;

                tr.innerHTML =
                    '<td>' + emailDisplay + '</td>' +
                    '<td>' + roleLabel + '</td>' +
                    '<td>' + statusLabel + '</td>' +
                    '<td>' + expiresAt + '</td>' +
                    '<td class="token-cell">' + escapeHtml(tokenShort) +
                    (isPending ? ' <button class="btn-small btn-copy" data-token="' + escapeHtml(inv.token) + '">コピー</button>' : '') +
                    '</td>' +
                    '<td>' +
                    (isPending ? '<button class="btn-small btn-danger btn-revoke" data-id="' + escapeHtml(inv.id) + '">取消</button>' : '-') +
                    '</td>';

                tbody.appendChild(tr);
            });

            // コピーボタンのイベント
            tbody.querySelectorAll('.btn-copy').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const token = this.getAttribute('data-token');
                    try {
                        await navigator.clipboard.writeText(token);
                        setStatus('招待コードをコピーしました', 'success');
                    } catch {
                        // フォールバック
                        const ta = document.createElement('textarea');
                        ta.value = token;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        document.body.removeChild(ta);
                        setStatus('招待コードをコピーしました', 'success');
                    }
                });
            });

            // 取消ボタンのイベント
            tbody.querySelectorAll('.btn-revoke').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const inviteId = this.getAttribute('data-id');
                    if (!confirm('この招待を取り消しますか？')) return;
                    await revokeInvite(inviteId);
                });
            });
        }

        async function createInvite() {
            const tenantId = getSelectedTenantId();
            if (!tenantId) return;

            const email = $('new-invite-email').value.trim();
            const role = $('new-invite-role').value;

            setStatus('招待を作成中...');
            const { data, error } = await _supabase.rpc('create_invite', {
                p_tenant_id: tenantId,
                p_email: email || '',
                p_role: role
            });

            if (error) {
                setStatus('招待作成失敗: ' + error.message, 'error');
                return;
            }

            // トークンをクリップボードにコピー
            if (data && data.token) {
                try {
                    await navigator.clipboard.writeText(data.token);
                    setStatus('招待を作成しました（コードをクリップボードにコピー済み）', 'success');
                } catch {
                    setStatus('招待を作成しました（コード: ' + data.token.substring(0, 8) + '...）', 'success');
                }
            } else {
                setStatus('招待を作成しました', 'success');
            }

            $('new-invite-email').value = '';
            await loadInvites();
        }

        async function revokeInvite(inviteId) {
            setStatus('招待を取り消し中...');
            const { error } = await _supabase.rpc('revoke_invite', { p_invite_id: inviteId });

            if (error) {
                setStatus('招待取消失敗: ' + error.message, 'error');
                return;
            }

            setStatus('招待を取り消しました', 'success');
            await loadInvites();
        }

        // --- メイン初期化 ---

        async function main() {
            const config = loadConfig();

            // URLフラグメントにトークンがあるか（OAuthコールバック）
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const hasAuthCallback = hashParams.has('access_token');

            if (hasAuthCallback && config) {
                // OAuthコールバック: configは保存済み
                initSupabase(config.url, config.key);
                $('supabase-url').value = config.url;
                $('supabase-key').value = config.key;

                // URLフラグメントをクリーンアップ
                history.replaceState(null, '', window.location.pathname + window.location.search);

                setStatus('認証情報を確認中...');
                const { data: { session } } = await _supabase.auth.getSession();
                if (session) {
                    await checkAdminAccess(session);
                } else {
                    showPanel('login-panel');
                    setStatus('セッションの確立に失敗しました', 'error');
                }
            } else if (config) {
                // 通常ロード: セッション復元試行
                initSupabase(config.url, config.key);
                $('supabase-url').value = config.url;
                $('supabase-key').value = config.key;

                const { data: { session } } = await _supabase.auth.getSession();
                if (session) {
                    await checkAdminAccess(session);
                } else {
                    showPanel('login-panel');
                    setStatus('ログインしてください');
                }
            } else {
                showPanel('config-panel');
                setStatus('Supabase接続情報を入力してください');
            }

            // --- イベントリスナー ---

            $('btn-connect').addEventListener('click', function() {
                const url = $('supabase-url').value.trim();
                const key = $('supabase-key').value.trim();
                if (!url || !key) {
                    setStatus('URLとAnon Keyを入力してください', 'error');
                    return;
                }
                try {
                    initSupabase(url, key);
                    saveConfig(url, key);
                    showPanel('login-panel');
                    setStatus('接続設定を保存しました。ログインしてください');
                } catch (e) {
                    setStatus('接続エラー: ' + e.message, 'error');
                }
            });

            $('btn-google-login').addEventListener('click', handleGoogleLogin);
            $('btn-logout').addEventListener('click', handleLogout);
            $('btn-disabled-logout').addEventListener('click', handleLogout);
            $('btn-create-invite').addEventListener('click', createInvite);
            $('btn-refresh').addEventListener('click', loadInvites);
            $('tenant-select').addEventListener('change', loadInvites);
        }

        // DOM準備完了後に実行
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
            main();
        }
    })();
    </script>
</body>
</html>
